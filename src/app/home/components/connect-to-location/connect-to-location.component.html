<ng-container
  *ngIf="{
    isActivated: isActivated$ | async,
    isConnecting: isConnecting$ | async,
    isDisconnecting: isDisconnecting$ | async,
    locationList: locationList$ | async
  } as obs"
>
  <ng-container *ngIf="obs.isActivated">
    <ng-container
      *ngTemplateOutlet="smartLocationButton; context: { obs: obs }"
    ></ng-container>
    <ng-container
      *ngTemplateOutlet="recommendedButton; context: { obs: obs }"
    ></ng-container>
    <ng-container
      *ngTemplateOutlet="locationsButton; context: { obs: obs }"
    ></ng-container>
  </ng-container>
</ng-container>

<ng-template #smartLocationButton let-obs="obs">
  <div class="button-container" *ngIf="smartLocation$ | async as smartLocation">
    <button
      mat-flat-button
      color="primary"
      (click)="connectToLocation(smartLocation.location)"
      [disabled]="obs.isConnecting || obs.isDisconnecting"
    >
      {{
        ("connectToSmartLocation" | translate) +
          " (" +
          smartLocation.location +
          ")"
      }}
    </button>
  </div>
</ng-template>

<ng-template #recommendedButton let-obs="obs">
  <div
    class="button-container"
    *ngIf="recommendedLocationsSortedByCountry$ | async as recommendedLocations"
  >
    <button
      mat-flat-button
      color="accent"
      (click)="showRecommendedLocations(recommendedLocations)"
      [disabled]="obs.isConnecting || obs.isDisconnecting"
    >
      {{ "connectToRecommendedLocation" | translate }}
    </button>
  </div>
</ng-template>

<ng-template #locationsButton let-obs="obs">
  <div
    class="button-container"
    *ngIf="locationsSortedByCountry$ | async as locations"
  >
    <button
      mat-flat-button
      color="accent"
      (click)="showLocations(locations)"
      [disabled]="obs.isConnecting || obs.isDisconnecting"
    >
      {{ "connectToLocation" | translate }}
    </button>
  </div>
</ng-template>

<ng-template #locationDialog>
  <h2 matDialogTitle>
    {{
      (recommendedLocations$ | async)
        ? ("connectToRecommendedLocation" | translate)
        : ("connectToLocation" | translate)
    }}
  </h2>
  <mat-dialog-content>
    <div class="location-list">
      <mat-accordion>
        <mat-expansion-panel
          *ngFor="let location of locationList$ | async"
          [expanded]="(selectedCountryCode$ | async) === location.countryCode"
          (opened)="selectCountryCode(location.countryCode)"
          hideToggle
        >
          <mat-expansion-panel-header>
            <mat-panel-title
              ><span [class]="'fi fi-' + location.countryCode"></span
              >{{ location.countryWithoutCode }}</mat-panel-title
            >
          </mat-expansion-panel-header>
          <mat-selection-list
            [multiple]="false"
            (selectionChange)="onCountrySelect($event)"
          >
            <mat-list-option
              *ngFor="let subLocation of location.locations"
              [value]="subLocation.location"
            >
              <div mat-line>
                <span [class]="'fi fi-' + location.countryCode"></span
                >{{ subLocation.location }}
              </div>
            </mat-list-option>
          </mat-selection-list>
        </mat-expansion-panel>
      </mat-accordion>
    </div>
  </mat-dialog-content>
  <mat-dialog-actions align="end">
    <button mat-button matDialogClose color="accent">
      {{ "close" | translate }}
    </button>
  </mat-dialog-actions>
</ng-template>
